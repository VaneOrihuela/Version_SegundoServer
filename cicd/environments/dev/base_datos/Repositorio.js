const conexion = require('./conexion');
const oracledb = require('oracledb');

const Repositorio = {
     // Función para verificar si la conexión está abierta
  verificarConexion: async (connection) => {
    try {
      // Realizamos una consulta sencilla para verificar si la conexión está activa
      await connection.execute('SELECT 1 FROM DUAL');
      return true; // Si la consulta pasa, la conexión está activa
    } catch (error) {
      console.error("La conexión está cerrada o no es válida:", error);
      return false; // Si ocurre un error, la conexión no es válida
    }
  },
  obtenerConexion: async () => {
    let connection = await conexion.conexion();  // Intentamos obtener la conexión

    const isConnectionActive = await Repositorio.verificarConexion(connection);
    
    // Si la conexión no está activa, la reabrimos
    if (!isConnectionActive) {
      console.log("Conexión cerrada. Intentando abrir una nueva...");
      connection = await conexion.conexion();
    }

    return connection;
  },
  // Función para obtener transacciones con los parámetros proporcionados
  obtenerTransacciones: async () => {
    let connection;
    try {
        connection = await Repositorio.obtenerConexion();

      const isConnectionActive = await Repositorio.verificarConexion(connection);
      if (!isConnectionActive) {
        throw new Error('La conexión no está activa o se cerró');
      }
      // Query para obtener las transacciones basadas en los filtros ORDER BY TRAN_DAT DESC
      const query = `
     SELECT 
    '240821' AS FECHA_TRASC,
    'L0039025'  AS TIENDA_TERM,  
    '0000003300000148' AS NUM_TARJETA,  
    '0000009683' AS BOLETA,  
    '2620000D018C212051320002303321204330001A202020202020202020202020202020202020372020302020202021204334000C30303135313030303036303021204648001420202020202020202020202020343834202020202120434800242020000000000000000020202020202020202020202020202031202020202020202020202120323800583336303330303030303030303030303030303030303030303030303030383030303033343233313332393030303033353030303030303030303030303736383637313332303131343030303030303135303030303131505921203332000C31313230303030303030414121205052000A3031313030203030303021205037001002F3544159F6BE0602F3544159F6BE3A21204238002220202020202020202020202020202020504F5320202020202020202020202020202021204239003C20202020202020202020202020202020202020202020202020202020202049534F3030333030302020202020202020202020202020202020202020202120513100023020' AS TOKEN_DATA 
FROM DUAL
UNION ALL
SELECT 
    '240821' AS FECHA_TRASC,  
    'L0039024'  AS TIENDA_TERM,  
    '0000003300000147' AS NUM_TARJETA,  
    '0000009683' AS BOLETA,  
    '2620000C04CA2120434900462020202030303030202020202020202020202020202020204C303033393032342020202020202020202020202020204E4E2020202020202020202020202020202020202020202120303400142020202020202020202020202049564F2020592021204330001A20202020203030313030303020202020202030202031203020202120433100105331415E535044485E494E545E3034202120433501E02030384C56303033393130303030323430303139363833303132313834303030313339353030303030303030303030303030303030303030303030303030303030313131313135303033393030300000000000000100011807460050000000027900000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFE500000128000039303231363631333030303030303030303030303030303030303030303030303030303039363932363133303036303031303234363836353836373920202020202020202020203531323139393120202020202020202020202030303030303030303533313131303230313042323420423234202020202042434D522020202020202020202020202020202020202030303030304D343039383531333030313139383730313D323731323F2020202020202020202020200020202020303030323731323000000000000220EC000000000000000034383434383436313030303030303631303030303030000000000000000000003630303030303030302020202120423700560000000000000000202020202020202020202020202020202020202020202020202020202020202020202030202020202020202020202020202020202020202020202020202020202020000120202020202020202020212042380022504F532020202020202020202020202020202020202020202020202020202020202021204239003C49534F3030303030302020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202120323800583030303030303030303030303030303030303030303030303030303030323030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303021203332000C202030303030303030302030212051310106F0F8D3E5F0F0F3F9F1F0F00024F00196830121840101395000000000000000003300000147F0F038F1F1D6D7C5D9C1C3C9D6D540C5E7C9E3D6E2C140404040404040404040404040404040404040000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000' AS TOKEN_DATA
FROM DUAL
UNION ALL
SELECT 
    '240821' AS FECHA_TRASC,  
    'L0390099'  AS TIENDA_TERM,  
    '0000003300000147' AS NUM_TARJETA,  
    '0000009683' AS BOLETA,  
    '2620000C04CA2120434900462020202030303030202020202020202020202020202020204C303033393032342020202020202020202020202020204E4E2020202020202020202020202020202020202020202120303400142020202020202020202020202049564F2020592021204330001A20202020203030313030303020202020202030202031203020202120433100105331415E535044485E494E545E3034202120433501E02030384C56303033393130303030323430303139363833303132313834303030313339353030303030303030303030303030303030303030303030303030303030313131313135303033393030300000000000000100011807460050000000027900000000000000000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFE500000128000039303231363631333030303030303030303030303030303030303030303030303030303039363932363133303036303031303234363836353836373920202020202020202020203531323139393120202020202020202020202030303030303030303533313131303230313042323420423234202020202042434D522020202020202020202020202020202020202030303030304D343039383531333030313139383730313D323731323F2020202020202020202020200020202020303030323731323000000000000220EC000000000000000034383434383436313030303030303631303030303030000000000000000000003630303030303030302020202120423700560000000000000000202020202020202020202020202020202020202020202020202020202020202020202030202020202020202020202020202020202020202020202020202020202020000120202020202020202020212042380022504F532020202020202020202020202020202020202020202020202020202020202021204239003C49534F3030303030302020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202120323800583030303030303030303030303030303030303030303030303030303030323030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303021203332000C202030303030303030302030212051310106F0F8D3E5F0F0F3F9F1F0F00024F00196830121840101395000000000000000003300000147F0F038F1F1D6D7C5D9C1C3C9D6D540C5E7C9E3D6E2C140404040404040404040404040404040404040000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000' AS TOKEN_DATA
FROM DUAL
UNION ALL
SELECT 
    '240821' AS FECHA_TRASC,  
    'L0390099'  AS TIENDA_TERM,  
    '0000003300000147' AS NUM_TARJETA,  
    '0000009683' AS BOLETA,  
    '2620000D018C212051320002303321204330001A202020202020202020202020202020202020372020302020202021204334000C30303135313030303036303021204648001420202020202020202020202020343834202020202120434800242020000000000000000020202020202020202020202020202031202020202020202020202120323800583335313030303030303030303030303030303030303030303030303030383030303030383437303030303030303030393030303030303030303030303533303030303332303731313030303030303433313231363131505921203332000C31313230303030303030414121205052000A3031313030203030303021205037001002F354415280B8A902F354415280B8DF21204238002220202020202020202020202020202020504F5320202020202020202020202020202021204239003C20202020202020202020202020202020202020202020202020202020202049534F3030333030302020202020202020202020202020202020202020202120513100023020' AS TOKEN_DATA  -- TOKEN_DATA es LONG, lo convertimos a VARCHAR2(4000)
FROM DUAL
UNION ALL
SELECT 
    '240821' AS FECHA_TRASC,  
    'L0390099'  AS TIENDA_TERM,  
    '0000003300000147' AS NUM_TARJETA,  
    '0000009683' AS BOLETA,  
    '2620000E04302120434900462020202030303030202020202020202020202020202020204C303331323030392020202020202020202020202020204E4E202020202020202020202020202020202020202020212030340014202020202020202020202020592020202020592021204330001A202020202030303130303030202020202020302020302030202021204234001430353135313030302020202020202020202030202120433100105331415E535044485E4C49565E3037202120433501E02030384C563033313231303030303039303031303137353030393131313030303030303838343430303030303030303431373834393930333231323630373232303030313030303030313237303325040107080409090003020102060007023D0207000302000100000000000802070000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF20200001282630E28D5F2A020484820238008407A0000000031010950500800088009A032502179C01009F02060000000088449F03060000000000009F0902008C9F100706011203A420229F1A0204849F1E0833413936363634379F2608DA7666FD797A93689F2701809F3303E0B0C89F34034403029F3501229F3602019E9F37049E7A50F99F4104000045179F5301529F6E008E00E15B4F07A00000000310109F120C56495341204352454400544F500C56495341204352454449544F5F30005F3401009F3403440302C20100950500800088009F2701809F2608DA7666FD797A93689B02E8009F3901058A0099009F6E0020202020202020202020202020202020202020202120514E000230302120423700560000000000000000202020202020202020202020202020202020202020202020202020202020202020202030202020202020202020202020202020202020202020202020202020202020000120202020202020202020212042380022504F5320202020202020202020202020504F5320202020202020202020202020202021204239003C49534F30303030303020202020202020202020202020202020202020202049534F3030333030302020202020202020202020202020202020202020202120323800583237303330303030303030303030303030303030303030303030303030383030303035393338393938353030303030353030303030303030303035343338393938353332303631383030303030303130303030303131505921203332000C31313230303030303030414121205131004AF0F8D3E5F0F3F1F2F1F0F00009F00101750091110100000000000000004178499032126072F1F138F0F040F0F0F0F3F1F4F2F2F0F040E3D9C1D5E2C1C3C3C9D6D540C1D7D9D6C2C1C4C1' AS TOKEN_DATA 
FROM DUAL
UNION ALL
SELECT 
    '240821' AS FECHA_TRASC,  
    'L0390099'  AS TIENDA_TERM,  
    '0000003300000147' AS NUM_TARJETA,  
    '0000009683' AS BOLETA, 
    '2620000C01C4212051320002303921204330001A202020202030303131313330302020202020362020312030313221204334000C31303235313030303336303021204336005030383030303230393535353439373030393735333238353033363534393730303030303030303030303030303032303230343931303634393636343032313630333239313036303030303030303030302120524A0028322020202020202020202020202020202020202020202020202020202020202020202020202020202120323800583237303430303030303030303030303030303030303030303030303030383030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303031435921203332000C31313230303030303030414121205052000A3031313030203030303021205037001002F354906637449802F354906637819121204238002220202020202020202020202020202020504F5320202020202020202020202020202021204239003C20202020202020202020202020202020202020202020202020202020202049534F303033303030202020202020202020202020202020202020202020'  AS TOKEN_DATA
FROM DUAL
      `;

      if (connection && connection.isClosed) {
        console.log('La conexión estaba cerrada, abriéndola de nuevo...');
        connection = await conexion.conexion();  // Reabrimos la conexión
      }
      // Ejecutar la consulta con los parámetros proporcionados
      const resultado = await connection.execute(query, [], { outFormat: oracledb.OUT_FORMAT_OBJECT });     
      // Retornamos todas las filas en un array
      return resultado.rows.map(row => ({
        FECHA_TRASC: row.FECHA_TRASC,
        TIENDA_TERM: row.TIENDA_TERM,
        NUM_TARJETA: row.NUM_TARJETA,
        BOLETA: row.BOLETA,
        TOKEN_DATA: row.TOKEN_DATA
      }));
    } catch (error) {
      console.error("Error al obtener transacciones:", error);
      throw error;
    } finally {
      if (connection) {
        try {
          await connection.close(); // Aseguramos cerrar la conexión después de la consulta
        } catch (err) {
          console.error("Error al cerrar la conexión:", err);
        }
      }
    }
  },

  GuardarTransacciones: async (xml) => {
    let connection;
    try {
        connection = await Repositorio.obtenerConexion();

      const isConnectionActive = await Repositorio.verificarConexion(connection);
      if (!isConnectionActive) {
        throw new Error('La conexión no está activa o se cerró');
      }
      // Query para obtener las transacciones basadas en los filtros ORDER BY TRAN_DAT DESC
      const query = `    
    INSERT INTO INFO_TOKEN (
    KQ2_ID_MEDIO_ACCESO,
    KQN_FLAG,
    KCH_RESP_SRC_RSN_CDE,
    KRJ_VERSION_3DS,
    KC0_IND_ECOM,
    KC0_CVV2,
    KC4_NIV_SEG,
    KC0_RESULTADO_VALIDACION_CAVV,
    KC4_ID_IND,
    KFH_ECOMM_3D_SECURE_IND,
    KFH_CAV_TYP,
    FECHA_TRANSACCION,
    TIENDA_TERMINAL,
    NUMERO_TARJETA,
    BOLETA,
    TIPO
)
SELECT    
    registro.KQ2_ID_MEDIO_ACCESO,
    registro.KQN_FLAG,
    registro.KCH_RESP_SRC_RSN_CDE,
    registro.KRJ_VERSION_3DS,
    registro.KC0_IND_ECOM,
    registro.KC0_CVV2,
    registro.KC4_NIV_SEG,
    registro.KC0_RESULTADO_VALIDACION_CAVV,
    registro.KC4_ID_IND,
    registro.KFH_ECOMM_3D_SECURE_IND,
    registro.KFH_CAV_TYP,
    registro.FECHA_TRASC,
    registro.TIENDA_TERM,
    registro.NUM_TARJETA,
    registro.BOLETA,
    '0' 
FROM
    XMLTABLE(
        '/Registros/Registro' 
        PASSING xmltype(:xml)
        COLUMNS
            KQ2_ID_MEDIO_ACCESO VARCHAR2(2) PATH 'KQ2_ID_MEDIO_ACCESO',
            KQN_FLAG VARCHAR2(2) PATH 'KQN_FLAG',
            KCH_RESP_SRC_RSN_CDE VARCHAR2(2) PATH 'KCH_RESP_SRC_RSN_CDE',
            KRJ_VERSION_3DS VARCHAR2(2) PATH 'KRJ_VERSION_3DS',
            KC0_IND_ECOM VARCHAR2(2) PATH 'KC0_IND_ECOM',
            KC0_CVV2 VARCHAR2(4) PATH 'KC0_CVV2',
            KC4_NIV_SEG VARCHAR2(1) PATH 'KC4_NIV_SEG',
            KC0_RESULTADO_VALIDACION_CAVV VARCHAR2(1) PATH 'KC0_RESULTADO_VALIDACION_CAVV',
            KC4_ID_IND VARCHAR2(1) PATH 'KC4_ID_IND',
            KFH_ECOMM_3D_SECURE_IND VARCHAR2(2) PATH 'KFH_ECOMM_3D_SECURE_IND',
            KFH_CAV_TYP VARCHAR2(2) PATH 'KFH_CAV_TYP',
            FECHA_TRASC VARCHAR2(20) PATH 'FECHA_TRASC',
            TIENDA_TERM VARCHAR2(20) PATH 'TIENDA_TERM',
            NUM_TARJETA VARCHAR2(20) PATH 'NUM_TARJETA',
            BOLETA VARCHAR2(20) PATH 'BOLETA'
    ) registro    
      `;

      if (connection && connection.isClosed) {
        console.log('La conexión estaba cerrada, abriéndola de nuevo...');
        connection = await conexion.conexion();  // Reabrimos la conexión
      }
      // Ejecutar la consulta con los parámetros proporcionados
      const resultado = await connection.execute(query, [xml], { outFormat: oracledb.OUT_FORMAT_OBJECT });
      await connection.commit();   
      console.log(`Número de filas insertadas: ${resultado.rowsAffected}`);
      return resultado.rowsAffected;
    } catch (error) {
      console.error("Error al obtener transacciones:", error);
      throw error;
    } finally {
      if (connection) {
        try {
          await connection.close(); // Aseguramos cerrar la conexión después de la consulta
        } catch (err) {
          console.error("Error al cerrar la conexión:", err);
        }
      }
    }
  },

};

module.exports = Repositorio;
